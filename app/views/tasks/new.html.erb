<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6 space-y-6">
  <div class="md:flex md:items-center md:justify-between mb-4">
    <div class="flex-1 min-w-0">
      <h2 class="text-2xl font-bold leading-7 text-gray-900 sm:text-3xl sm:truncate">
        <%= t('tasks.new.title') %>
      </h2>
      <p class="mt-1 text-sm text-gray-500"><%= t('tasks.new.description') %></p>
    </div>
    <div class="mt-4 flex md:mt-0 md:ml-4">
      <%= link_to tasks_path, class: "inline-flex items-center px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500" do %>
        <svg class="h-4 w-4 mr-1.5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
        </svg>
        <%= t('tasks.new.back_to_list') %>
      <% end %>
    </div>
  </div>

  <div class="bg-white shadow overflow-hidden sm:rounded-lg">
    <div class="px-4 py-5 sm:px-6 bg-blue-50 border-b border-gray-200">
      <h3 class="text-lg font-medium leading-6 text-gray-900 flex items-center">
        <svg class="h-5 w-5 text-blue-500 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
          <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-11a1 1 0 10-2 0v2H7a1 1 0 100 2h2v2a1 1 0 102 0v-2h2a1 1 0 100-2h-2V7z" clip-rule="evenodd" />
        </svg>
        <%= t('tasks.new.create_form_title') %>
      </h3>
      <p class="mt-1 max-w-2xl text-sm text-gray-500">
        <%= t('tasks.new.select_task_type_instruction') %>
      </p>
    </div>

    <div class="px-4 py-5 sm:p-6">
      <%= form_with(model: @task, class: "space-y-6") do |form| %>
        <% if @task.errors.any? %>
          <div class="rounded-md bg-red-50 p-4">
            <div class="flex">
              <div class="flex-shrink-0">
                <svg class="h-5 w-5 text-red-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                  <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                </svg>
              </div>
              <div class="ml-3">
                <h3 class="text-sm font-medium text-red-800">
                  <%= t('errors.template.header', count: @task.errors.count, model: Task.model_name.human) %>
                </h3>
                <div class="mt-2 text-sm text-red-700">
                  <ul class="list-disc pl-5 space-y-1">
                    <% @task.errors.each do |error| %>
                      <li><%= error.full_message %></li>
                    <% end %>
                  </ul>
                </div>
              </div>
            </div>
          </div>
        <% end %>

        <div class="bg-blue-50 p-4 rounded-lg">
          <label for="task-type-select" class="block text-sm font-medium text-gray-700 mb-1 flex items-center">
            <svg class="h-4 w-4 mr-1.5 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"></path>
            </svg>
            <%= t('tasks.new.task_type') %> <span class="text-red-500 ml-1">*</span>
          </label>
          <div class="mt-1 relative">
            <%= form.select :task_type, 
                Task.task_types.keys.map { |t| [t("activerecord.enums.task.task_type.#{t}"), t] }, 
                { include_blank: t('tasks.new.select_task_type') }, 
                { class: "block w-full pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md shadow-sm", 
                  id: "task-type-select",
                  required: true } %>
            <div class="mt-1 text-xs text-gray-500">
              <%= t('tasks.new.select_task_type_instruction') %>
            </div>
          </div>
        </div>

        <!-- 地图选择字段 -->
        <div id="map-selection-fields">
          <div class="border-t border-gray-200 pt-4">
            <div class="bg-indigo-50 p-4 rounded-lg">
              <h3 class="text-lg font-medium text-gray-900 mb-3 flex items-center">
                <svg class="h-5 w-5 mr-2 text-indigo-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7" />
                </svg>
                <%= t('tasks.new.map_selection') %>
              </h3>
              <div class="sm:grid sm:grid-cols-3 sm:gap-4 sm:items-start">
                <label for="task_map_id" class="block text-sm font-medium text-gray-700 sm:mt-px sm:pt-2 flex items-center">
                  <svg class="h-4 w-4 mr-1.5 text-indigo-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                  </svg>
                  <%= t('tasks.new.map') %>
                </label>
                <div class="mt-1 sm:mt-0 sm:col-span-2">
                  <%= form.collection_select :map_id, Map.all, :id, :name, 
                      { include_blank: t('tasks.new.select_map') }, 
                      class: "max-w-lg block focus:ring-indigo-500 focus:border-indigo-500 w-full shadow-sm sm:max-w-xs sm:text-sm border-gray-300 rounded-md" %>
                  
                  <div class="mt-1 text-sm text-gray-500 flex items-center">
                    <span class="mr-2"><%= t('tasks.new.map_hint') %></span>
                    <%= link_to t('tasks.new.create_new_map'), new_map_path, class: "text-indigo-600 hover:text-indigo-900" %>
                  </div>
                  
                  <div id="active-map-indicator" class="mt-2 hidden">
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                      <svg class="-ml-0.5 mr-1.5 h-2 w-2 text-green-400" fill="currentColor" viewBox="0 0 8 8">
                        <circle cx="4" cy="4" r="3" />
                      </svg>
                      <%= t('maps.status.active') %>
                    </span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div id="common-fields">
          <div class="border-t border-gray-200 pt-4">
            <div class="bg-gray-50 p-4 rounded-lg">
              <h3 class="text-lg font-medium text-gray-900 mb-3 flex items-center">
                <svg class="h-5 w-5 mr-2 text-gray-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"></path>
                </svg>
                <%= t('tasks.new.common_parameters') %>
              </h3>
              <div class="sm:grid sm:grid-cols-3 sm:gap-4 sm:items-start">
                <label for="task_priority" class="block text-sm font-medium text-gray-700 sm:mt-px sm:pt-2 flex items-center">
                  <svg class="h-4 w-4 mr-1.5 text-gray-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4h13M3 8h9m-9 4h6m4 0l4-4m0 0l4 4m-4-4v12"></path>
                  </svg>
                  <%= t('tasks.new.priority') %>
                </label>
                <div class="mt-1 sm:mt-0 sm:col-span-2">
                  <div class="flex items-center justify-between mb-1 text-xs text-gray-500">
                    <span><%= t('tasks.new.priority_levels.low') %></span>
                    <span><%= t('tasks.new.priority_levels.medium') %></span>
                    <span><%= t('tasks.new.priority_levels.high') %></span>
                  </div>
                  
                  <div class="flex items-center space-x-3">
                    <input type="range" id="priority_slider" min="0" max="10" step="1" value="0" 
                          class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-blue-600"
                          oninput="updatePriorityValue(this.value)">
                    <%= form.number_field :priority, value: 0, min: 0, max: 10, class: "w-16 text-center px-2 py-1 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500", 
                          id: "priority_number", oninput: "document.getElementById('priority_slider').value = this.value" %>
                  </div>
                  
                  <div class="mt-2">
                    <span id="priority_label" class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                      <%= t('tasks.new.priority_levels.low') %>
                    </span>
                    <p class="mt-1 text-xs text-gray-500">
                      <%= t('tasks.new.priority_value_hint') %>
                    </p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- 导航任务表单字段 -->
        <div id="navigation-fields" class="task-fields hidden">
          <div class="border-t border-gray-200 pt-4">
            <div class="bg-green-50 p-4 rounded-lg">
              <div class="flex items-center border-b border-green-200 pb-3 mb-3">
                <svg class="h-5 w-5 text-green-500 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                  <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd" />
                </svg>
                <h3 class="text-lg font-medium text-gray-900"><%= t('tasks.navigation_params.title') %></h3>
              </div>
              
              <div class="mt-4 grid grid-cols-1 gap-y-6 gap-x-4 sm:grid-cols-3">
                <div>
                  <label for="task_target_point_x" class="block text-sm font-medium text-gray-700 flex items-center">
                    <svg class="h-4 w-4 mr-1.5 text-green-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 6v2m3-2v2m3-2v2M9 3h.01M12 3h.01M15 3h.01M21 21v-7a2 2 0 00-2-2H5a2 2 0 00-2 2v7h18zm-3-9v-2a2 2 0 00-2-2H8a2 2 0 00-2 2v2"></path>
                    </svg>
                    <%= t('tasks.navigation_params.target_point_x') %> <span class="text-red-500 ml-1">*</span>
                  </label>
                  <div class="mt-1 relative rounded-md shadow-sm">
                    <%= form.number_field :target_point_x, step: "any", class: "block w-full pr-10 focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm border-gray-300 rounded-md", placeholder: "0.0" %>
                    <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none">
                      <span class="text-gray-500 sm:text-sm">m</span>
                    </div>
                  </div>
                </div>
                
                <div>
                  <label for="task_target_point_y" class="block text-sm font-medium text-gray-700 flex items-center">
                    <svg class="h-4 w-4 mr-1.5 text-green-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <%= t('tasks.navigation_params.target_point_y') %> <span class="text-red-500 ml-1">*</span>
                  </label>
                  <div class="mt-1 relative rounded-md shadow-sm">
                    <%= form.number_field :target_point_y, step: "any", class: "block w-full pr-10 focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm border-gray-300 rounded-md", placeholder: "0.0" %>
                    <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none">
                      <span class="text-gray-500 sm:text-sm">m</span>
                    </div>
                  </div>
                </div>
                
                <div>
                  <label for="task_target_point_z" class="block text-sm font-medium text-gray-700 flex items-center">
                    <svg class="h-4 w-4 mr-1.5 text-green-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 6V3m3 3V3m3 3V3M9 3h.01M12 3h.01M15 3h.01M21 21v-7a2 2 0 00-2-2H5a2 2 0 00-2 2v7h18zm-3-9v-2a2 2 0 00-2-2H8a2 2 0 00-2 2v2"></path>
                    </svg>
                    <%= t('tasks.navigation_params.target_point_z') %>
                  </label>
                  <div class="mt-1 relative rounded-md shadow-sm">
                    <%= form.number_field :target_point_z, step: "any", class: "block w-full pr-10 focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm border-gray-300 rounded-md", placeholder: "0.0" %>
                    <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none">
                      <span class="text-gray-500 sm:text-sm">m</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- 书籍搬运任务表单字段 -->
        <div id="book-transfer-fields" class="task-fields hidden">
          <div class="border-t border-gray-200 pt-4">
            <div class="bg-blue-50 p-4 rounded-lg">
              <div class="flex items-center border-b border-blue-200 pb-3 mb-3">
                <svg class="h-5 w-5 text-blue-500 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                  <path d="M9 4.804A7.968 7.968 0 005.5 4c-1.255 0-2.443.29-3.5.804v10A7.969 7.969 0 015.5 14c1.669 0 3.218.51 4.5 1.385A7.962 7.962 0 0114.5 14c1.255 0 2.443.29 3.5.804v-10A7.968 7.968 0 0014.5 4c-1.255 0-2.443.29-3.5.804V12a1 1 0 11-2 0V4.804z" />
                </svg>
                <h3 class="text-lg font-medium text-gray-900"><%= t('tasks.book_transfer_params.title') %></h3>
              </div>
              
              <div class="mt-4 grid grid-cols-1 gap-y-6 gap-x-4 sm:grid-cols-6">
                <div class="sm:col-span-6">
                  <label for="task_book_id" class="block text-sm font-medium text-gray-700 flex items-center">
                    <svg class="h-4 w-4 mr-1.5 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
                    </svg>
                    <%= t('tasks.book_transfer_params.select_book') %> <span class="text-red-500 ml-1">*</span>
                  </label>
                  <div class="mt-1">
                    <%= form.collection_select :book_id, @books, :id, :title, { include_blank: t('tasks.book_transfer_params.select_book_placeholder') }, 
                      { class: "block w-full focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm border-gray-300 rounded-md shadow-sm" } %>
                  </div>
                </div>
                
                <div class="sm:col-span-6">
                  <label for="task_source_slot_id" class="block text-sm font-medium text-gray-700 flex items-center">
                    <svg class="h-4 w-4 mr-1.5 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 19a2 2 0 01-2-2V7a2 2 0 012-2h4l2 2h4a2 2 0 012 2v1M5 19h14a2 2 0 002-2v-5a2 2 0 00-2-2H9a2 2 0 00-2 2v5a2 2 0 01-2 2z"></path>
                    </svg>
                    <%= t('tasks.book_transfer_params.source_slot') %> <span class="text-red-500 ml-1">*</span>
                  </label>
                  <div class="mt-1">
                    <%= form.collection_select :source_slot_id, @slots, :id, lambda { |s| "#{s.bookshelf.name} - #{t('slot.level')}#{s.level + 1}#{t('slot.row')}#{s.row + 1}" }, 
                      { include_blank: t('tasks.book_transfer_params.select_source_slot') }, 
                      { class: "block w-full focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm border-gray-300 rounded-md shadow-sm" } %>
                  </div>
                </div>

                <div id="return-book-fields" class="sm:col-span-6 hidden">
                  <label for="task_target_slot_id" class="block text-sm font-medium text-gray-700 flex items-center">
                    <svg class="h-4 w-4 mr-1.5 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"></path>
                    </svg>
                    <%= t('tasks.book_transfer_params.target_slot') %> <span class="text-red-500 ml-1">*</span>
                  </label>
                  <div class="mt-1">
                    <%= form.collection_select :target_slot_id, @slots, :id, lambda { |s| "#{s.bookshelf.name} - #{t('slot.level')}#{s.level + 1}#{t('slot.row')}#{s.row + 1}" }, 
                      { include_blank: t('tasks.book_transfer_params.select_target_slot') }, 
                      { class: "block w-full focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm border-gray-300 rounded-md shadow-sm" } %>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- 建图任务表单字段 -->
        <div id="map-fields" class="task-fields hidden">
          <div class="border-t border-gray-200 pt-4">
            <div class="bg-purple-50 p-4 rounded-lg">
              <div class="flex items-center border-b border-purple-200 pb-3 mb-3">
                <svg class="h-5 w-5 text-purple-500 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                  <path fill-rule="evenodd" d="M12 1.586l-4 4v12.828l4-4V1.586zM3.707 3.293A1 1 0 002 4v10a1 1 0 00.293.707L6 18.414V5.586L3.707 3.293zM17.707 5.293L14 1.586v12.828l2.293 2.293A1 1 0 0018 16V6a1 1 0 00-.293-.707z" clip-rule="evenodd" />
                </svg>
                <h3 class="text-lg font-medium text-gray-900"><%= t('tasks.map_params.title') %></h3>
              </div>
              
              <div class="mt-4 grid grid-cols-1 gap-y-6 gap-x-4 sm:grid-cols-6">
                <div class="sm:col-span-6">
                  <label for="map_name" class="block text-sm font-medium text-gray-700 flex items-center">
                    <svg class="h-4 w-4 mr-1.5 text-purple-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M3 14h18m-9-4v8m-7 0h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                    </svg>
                    <%= t('tasks.map_params.map_name') %> <span class="text-red-500 ml-1">*</span>
                  </label>
                  <div class="mt-1">
                    <input type="text" name="task[parameters][map_name]" id="map_name" class="block w-full focus:outline-none focus:ring-purple-500 focus:border-purple-500 sm:text-sm border-gray-300 rounded-md shadow-sm" placeholder="library_map_v1">
                  </div>
                </div>
                
                <div class="sm:col-span-3">
                  <label for="time_limit" class="block text-sm font-medium text-gray-700 flex items-center">
                    <svg class="h-4 w-4 mr-1.5 text-purple-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <%= t('tasks.map_params.time_limit') %>
                  </label>
                  <div class="mt-1 relative rounded-md shadow-sm">
                    <input type="number" name="task[parameters][time_limit]" id="time_limit" value="10" min="1" max="60" class="block w-full pr-10 focus:outline-none focus:ring-purple-500 focus:border-purple-500 sm:text-sm border-gray-300 rounded-md shadow-sm">
                    <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none">
                      <span class="text-gray-500 sm:text-sm"><%= t('tasks.map_params.minutes') %></span>
                    </div>
                  </div>
                  <p class="mt-2 text-xs text-gray-500">
                    <%= t('tasks.map_params.time_limit_hint') %>
                  </p>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- 加载地图任务表单字段 -->
        <div id="load-map-fields" class="task-fields hidden">
          <div class="border-t border-gray-200 pt-4">
            <div class="bg-indigo-50 p-4 rounded-lg">
              <div class="flex items-center border-b border-indigo-200 pb-3 mb-3">
                <svg class="h-5 w-5 text-indigo-500 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                  <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" />
                </svg>
                <h3 class="text-lg font-medium text-gray-900"><%= t('tasks.load_map_params.title') %></h3>
              </div>
              
              <div class="mt-4 sm:col-span-6">
                <label for="map_id" class="block text-sm font-medium text-gray-700 flex items-center">
                  <svg class="h-4 w-4 mr-1.5 text-indigo-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"></path>
                  </svg>
                  <%= t('tasks.load_map_params.map_id') %> <span class="text-red-500 ml-1">*</span>
                </label>
                <div class="mt-1">
                  <input type="text" name="task[parameters][map_id]" id="map_id" class="block w-full focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm border-gray-300 rounded-md shadow-sm" placeholder="library_map_v1">
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- 库存扫描任务表单字段 -->
        <div id="inventory-fields" class="task-fields hidden">
          <div class="border-t border-gray-200 pt-4">
            <div class="bg-orange-50 p-4 rounded-lg">
              <div class="flex items-center border-b border-orange-200 pb-3 mb-3">
                <svg class="h-5 w-5 text-orange-500 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                  <path d="M7 3a1 1 0 000 2h6a1 1 0 100-2H7zM4 7a1 1 0 011-1h10a1 1 0 110 2H5a1 1 0 01-1-1zM2 11a2 2 0 012-2h12a2 2 0 012 2v4a2 2 0 01-2 2H4a2 2 0 01-2-2v-4z" />
                </svg>
                <h3 class="text-lg font-medium text-gray-900"><%= t('tasks.inventory_params.title') %></h3>
              </div>
              
              <div class="mt-4 grid grid-cols-1 gap-y-6 gap-x-4 sm:grid-cols-6">
                <div class="sm:col-span-6">
                  <label for="bookshelf_id" class="block text-sm font-medium text-gray-700 flex items-center">
                    <svg class="h-4 w-4 mr-1.5 text-orange-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 19a2 2 0 01-2-2V7a2 2 0 012-2h4l2 2h4a2 2 0 012 2v1M5 19h14a2 2 0 002-2v-5a2 2 0 00-2-2H9a2 2 0 00-2 2v5a2 2 0 01-2 2z"></path>
                    </svg>
                    <%= t('tasks.inventory_params.select_bookshelf') %>
                  </label>
                  <div class="mt-1">
                    <select name="task[parameters][bookshelf_id]" id="bookshelf_id" class="block w-full focus:outline-none focus:ring-orange-500 focus:border-orange-500 sm:text-sm border-gray-300 rounded-md shadow-sm">
                      <option value=""><%= t('tasks.inventory_params.all_bookshelves') %></option>
                      <% Bookshelf.all.each do |bookshelf| %>
                        <option value="<%= bookshelf.id %>"><%= bookshelf.name %></option>
                      <% end %>
                    </select>
                  </div>
                  <p class="mt-2 text-xs text-gray-500">
                    <%= t('tasks.inventory_params.bookshelf_hint') %>
                  </p>
                </div>
                
                <div class="sm:col-span-6">
                  <div class="flex items-start">
                    <div class="flex items-center h-5">
                      <input id="auto-relocate" type="checkbox" name="task[parameters][auto_relocate]" value="true" class="h-4 w-4 text-orange-600 focus:ring-orange-500 border-gray-300 rounded">
                    </div>
                    <div class="ml-3 text-sm">
                      <label for="auto-relocate" class="font-medium text-gray-700"><%= t('tasks.inventory_params.auto_relocate') %></label>
                      <p class="text-gray-500 text-xs mt-1"><%= t('tasks.inventory_params.auto_relocate_hint') %></p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="pt-5 border-t border-gray-200">
          <div class="flex justify-end">
            <%= link_to t('common.cancel'), tasks_path, class: "py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500" %>
            <%= form.submit t('tasks.new.create_task'), class: "ml-3 inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 cursor-pointer" %>
          </div>
        </div>
      <% end %>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // 任务类型选择变化时显示相应字段
    const taskTypeSelect = document.getElementById('task-type-select');
    
    taskTypeSelect.addEventListener('change', function() {
      // 隐藏所有任务类型特定字段
      document.querySelectorAll('.task-fields').forEach(function(field) {
        field.classList.add('hidden');
      });
      
      const selectedType = taskTypeSelect.value;
      if (!selectedType) return;
      
      // 根据任务类型显示相应字段
      if (selectedType === 'navigation_to_point') {
        document.getElementById('navigation-fields').classList.remove('hidden');
      } else if (selectedType === 'fetch_book_to_transfer') {
        document.getElementById('book-transfer-fields').classList.remove('hidden');
      } else if (selectedType === 'return_book_from_transfer') {
        document.getElementById('book-transfer-fields').classList.remove('hidden');
        document.getElementById('return-book-fields').classList.remove('hidden');
      } else if (selectedType === 'map_build_auto') {
        document.getElementById('map-fields').classList.remove('hidden');
      } else if (selectedType === 'load_map') {
        document.getElementById('load-map-fields').classList.remove('hidden');
      } else if (['inventory_scan_and_relocate', 'inventory_full_inspection'].includes(selectedType)) {
        document.getElementById('inventory-fields').classList.remove('hidden');
      }
    });
    
    // 优先级控件相关函数
    function updatePriorityValue(value) {
      document.getElementById('priority_number').value = value;
      updatePriorityLabel(value);
    }
    
    function updatePriorityLabel(value) {
      const label = document.getElementById('priority_label');
      const intValue = parseInt(value);
      
      if (intValue >= 0 && intValue <= 2) {
        label.textContent = '<%= t('tasks.new.priority_levels.low') %>';
        label.className = 'inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800';
      } else if (intValue >= 3 && intValue <= 7) {
        label.textContent = '<%= t('tasks.new.priority_levels.medium') %>';
        label.className = 'inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800';
      } else {
        label.textContent = '<%= t('tasks.new.priority_levels.high') %>';
        label.className = 'inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800';
      }
    }
    
    // 绑定事件
    document.getElementById('priority_slider').addEventListener('input', function() {
      updatePriorityValue(this.value);
    });
    
    document.getElementById('priority_number').addEventListener('input', function() {
      document.getElementById('priority_slider').value = this.value;
      updatePriorityLabel(this.value);
    });
    
    // 初始化时设置标签
    updatePriorityLabel(document.getElementById('priority_number').value);
    
    // 如果URL中有task_type参数，自动选择对应任务类型
    const urlParams = new URLSearchParams(window.location.search);
    const taskType = urlParams.get('task_type');
    if (taskType) {
      taskTypeSelect.value = taskType;
      taskTypeSelect.dispatchEvent(new Event('change'));
    }
  });
</script>
