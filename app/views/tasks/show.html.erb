<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6 space-y-6">
  <div class="md:flex md:items-center md:justify-between mb-4" data-task-detail-id="<%= @task.id %>">
    <div class="flex-1 min-w-0">
      <h2 class="text-2xl font-bold leading-7 text-gray-900 sm:text-3xl sm:truncate flex items-center">
        <%= t('tasks.show.title') %> #<%= @task.id %>
        <span class="ml-3 inline-flex items-center px-3 py-1 rounded-full text-sm font-medium task-status-badge
          <%= case @task.status
              when 'pending' then 'bg-gray-100 text-gray-800'
              when 'processing' then 'bg-blue-100 text-blue-800'
              when 'completed' then 'bg-green-100 text-green-800'
              when 'failed' then 'bg-red-100 text-red-800'
              when 'cancelled' then 'bg-yellow-100 text-yellow-800'
              when 'cancelling' then 'bg-orange-100 text-orange-800'
              end %>">
          <% icon_class = case @task.status
                          when 'pending' then 'pending'
                          when 'processing' then 'processing'
                          when 'completed' then 'completed'
                          when 'failed' then 'failed'
                          when 'cancelled', 'cancelling' then 'cancelled'
                          end %>
          <% if icon_class == 'pending' %>
            <svg class="h-4 w-4 mr-1.5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="12" cy="12" r="10"></circle>
              <polyline points="12 6 12 12 16 14"></polyline>
            </svg>
          <% elsif icon_class == 'processing' %>
            <svg class="h-4 w-4 mr-1.5 animate-spin" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <line x1="12" y1="2" x2="12" y2="6"></line>
              <line x1="12" y1="18" x2="12" y2="22"></line>
              <line x1="4.93" y1="4.93" x2="7.76" y2="7.76"></line>
              <line x1="16.24" y1="16.24" x2="19.07" y2="19.07"></line>
              <line x1="2" y1="12" x2="6" y2="12"></line>
              <line x1="18" y1="12" x2="22" y2="12"></line>
              <line x1="4.93" y1="19.07" x2="7.76" y2="16.24"></line>
              <line x1="16.24" y1="7.76" x2="19.07" y2="4.93"></line>
            </svg>
          <% elsif icon_class == 'completed' %>
            <svg class="h-4 w-4 mr-1.5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
              <polyline points="22 4 12 14.01 9 11.01"></polyline>
            </svg>
          <% elsif icon_class == 'failed' %>
            <svg class="h-4 w-4 mr-1.5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="12" cy="12" r="10"></circle>
              <line x1="15" y1="9" x2="9" y2="15"></line>
              <line x1="9" y1="9" x2="15" y2="15"></line>
            </svg>
          <% elsif icon_class == 'cancelled' %>
            <svg class="h-4 w-4 mr-1.5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="12" cy="12" r="10"></circle>
              <line x1="8" y1="12" x2="16" y2="12"></line>
            </svg>
          <% end %>
          <%= t("activerecord.enums.task.status.#{@task.status}") %>
        </span>
      </h2>
      <p class="mt-1 flex items-center text-sm text-gray-500">
        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium mr-2
          <%= case @task.task_type
              when 'map_build_auto' then 'bg-purple-100 text-purple-800'
              when 'navigation_to_point' then 'bg-green-100 text-green-800'
              when 'fetch_book_to_transfer' then 'bg-blue-100 text-blue-800'
              when 'return_book_from_transfer' then 'bg-yellow-100 text-yellow-800'
              when 'inventory_scan_and_relocate' then 'bg-orange-100 text-orange-800'
              when 'inventory_full_inspection' then 'bg-red-100 text-red-800'
              when 'load_map' then 'bg-indigo-100 text-indigo-800'
              else 'bg-gray-100 text-gray-800'
              end %>">
          <%= t("activerecord.enums.task.task_type.#{@task.task_type}") %>
        </span>
        <svg class="h-4 w-4 text-gray-400 mr-1.5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
        </svg>
        <%= @task.user.username %> ·
        <svg class="h-4 w-4 text-gray-400 ml-2 mr-1.5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
        </svg>
        <%= @task.created_at.strftime('%Y-%m-%d %H:%M:%S') %>
      </p>
    </div>
    <div class="mt-4 flex flex-wrap md:mt-0 md:ml-4 gap-2">
      <%= link_to tasks_path, class: "inline-flex items-center px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500" do %>
        <svg class="h-4 w-4 mr-1.5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
        </svg>
        <%= t('tasks.show.back_to_list') %>
      <% end %>
      
      <% if @task.pending? %>
        <%= link_to edit_task_path(@task), class: "inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500" do %>
          <svg class="h-4 w-4 mr-1.5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
          </svg>
          <%= t('tasks.show.edit_task') %>
        <% end %>
      <% end %>
      
      <% if @task.pending? || @task.processing? %>
        <%= button_to cancel_task_path(@task), method: :post, class: "inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-amber-500 hover:bg-amber-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-amber-500 task-cancel-button", style: "background-color: #f97316;", data: { turbo_confirm: t('tasks.show.confirm_cancel')} do %>
          <svg class="h-4 w-4 mr-1.5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 9v6m4-6v6m7-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
          </svg>
          <%= t('tasks.show.cancel_task') %>
        <% end %>
      <% end %>
      
      <% if !@task.processing? && !@task.cancelling? %>
        <%= button_to task_path(@task), method: :delete, class: "inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500", data: { turbo_confirm: t('tasks.show.confirm_delete') } do %>
          <svg class="h-4 w-4 mr-1.5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
          </svg>
          <%= t('tasks.show.delete_task') %>
        <% end %>
      <% end %>

      <% if Current.user&.admin? %>
        <div class="relative inline-block text-left" data-controller="dropdown">
          <button type="button" class="inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-purple-600 hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500" data-action="click->dropdown#toggle">
            <%= t('tasks.show.test_actions') %>
            <svg class="-mr-1 ml-2 h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
            </svg>
          </button>
          <div class="hidden origin-top-right absolute right-0 mt-2 w-56 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 focus:outline-none" data-dropdown-target="menu" role="menu" aria-orientation="vertical" tabindex="-1">
            <div class="py-1">
              <%= button_to test_update_task_path(@task, status: 'pending'), method: :post, class: "text-left w-full px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 hover:text-gray-900", role: "menuitem" do %>
                <%= t('tasks.show.test_pending') %>
              <% end %>
              
              <%= button_to test_update_task_path(@task, status: 'processing'), method: :post, class: "text-left w-full px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 hover:text-gray-900", role: "menuitem" do %>
                <%= t('tasks.show.test_processing') %>
              <% end %>
              
              <%= button_to test_update_task_path(@task, status: 'completed'), method: :post, class: "text-left w-full px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 hover:text-gray-900", role: "menuitem" do %>
                <%= t('tasks.show.test_completed') %>
              <% end %>
              
              <%= button_to test_update_task_path(@task, status: 'failed'), method: :post, class: "text-left w-full px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 hover:text-gray-900", role: "menuitem" do %>
                <%= t('tasks.show.test_failed') %>
              <% end %>
              
              <%= button_to test_update_task_path(@task, status: 'cancelled'), method: :post, class: "text-left w-full px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 hover:text-gray-900", role: "menuitem" do %>
                <%= t('tasks.show.test_cancelled') %>
              <% end %>
              
              <%= button_to test_update_task_path(@task, status: 'processing', add_progress: '1'), method: :post, class: "text-left w-full px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 hover:text-gray-900", role: "menuitem" do %>
                <%= t('tasks.show.test_with_progress') %>
              <% end %>
            </div>
          </div>
        </div>
      <% end %>
    </div>
  </div>

  <!-- 添加连接状态指示器 -->
  <div class="bg-white shadow-sm rounded-lg p-2 flex items-center justify-between mb-4">
    <div class="flex items-center">
      <div class="bg-indigo-100 p-2 rounded-md mr-3">
        <svg class="w-5 h-5 text-indigo-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
        </svg>
      </div>
      <span class="text-sm font-medium text-gray-600"><%= t('tasks.show.real_time_updates') %></span>
    </div>
    <div class="websocket-status-container">
      <!-- WebSocket状态将由JavaScript填充 -->
      <div class="flex items-center text-sm">
        <svg class="h-4 w-4 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
          <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd"></path>
        </svg>
        <span class="ml-1"><%= t('tasks.show.connecting') %></span>
      </div>
    </div>
  </div>

  <!-- 添加全局进度指示器 -->
  <% if @task.processing? || @task.status == 'pending' %>
    <div class="bg-white shadow-sm rounded-lg p-4 mb-4">
      <div class="flex items-center justify-between mb-2">
        <div class="flex items-center">
          <div class="bg-blue-100 p-2 rounded-full mr-3">
            <svg class="w-5 h-5 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
            </svg>
          </div>
          <h3 class="text-lg font-medium text-gray-900">
            <%= @task.processing? ? t('tasks.show.task_in_progress') : t('tasks.show.task_pending') %>
          </h3>
        </div>
        
        <div>
          <span class="px-2.5 py-0.5 rounded-full text-xs font-medium
            <%= case @task.status
                when 'pending' then 'bg-gray-100 text-gray-800'
                when 'processing' then 'bg-blue-100 text-blue-800'
                when 'completed' then 'bg-green-100 text-green-800'
                when 'failed' then 'bg-red-100 text-red-800'
                when 'cancelled' then 'bg-yellow-100 text-yellow-800'
                when 'cancelling' then 'bg-orange-100 text-orange-800'
                end %>">
            <%= t("activerecord.enums.task.status.#{@task.status}") %>
          </span>
        </div>
      </div>
      
      <div class="mt-4">
        <div class="relative pt-1">
          <div class="flex mb-2 items-center justify-between">
            <div>
              <span class="text-xs font-semibold inline-block py-1 px-2 uppercase rounded-full bg-blue-100 text-blue-600 task-status-message">
                <%= @task.processing? ? t('tasks.show.task_in_progress') : t('tasks.show.waiting_to_start') %>
              </span>
            </div>
            <div class="text-right">
              <span class="text-xs font-semibold inline-block text-blue-600 task-progress-percentage">
                <%= @task.progress_details.present? && JSON.parse(@task.progress_details)['progress_percentage'] ? "#{JSON.parse(@task.progress_details)['progress_percentage']}%" : "0%" %>
              </span>
            </div>
          </div>
          <div class="overflow-hidden h-2 mb-4 text-xs flex rounded bg-blue-100">
            <div style="width: <%= @task.progress_details.present? && JSON.parse(@task.progress_details)['progress_percentage'] ? "#{JSON.parse(@task.progress_details)['progress_percentage']}%" : "0%" %>" class="shadow-none flex flex-col text-center whitespace-nowrap text-white justify-center bg-blue-500 task-progress-bar transition-all duration-500 ease-in-out"></div>
          </div>
        </div>

        <div class="mt-2 text-xs text-gray-500 task-realtime-update-message"></div>
      </div>
    </div>
  <% end %>
  
  <!-- 添加建图监控组件 -->
  <% if @task.map_build_auto? %>
    <%= render 'map_building_monitor', task: @task %>
  <% end %>

  <!-- 基本信息卡片 -->
  <div class="bg-white shadow overflow-hidden sm:rounded-lg">
    <div class="px-4 py-5 sm:px-6 border-b border-gray-200 flex items-center">
      <div class="bg-blue-100 p-2 rounded-md mr-3">
        <svg class="w-5 h-5 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
        </svg>
      </div>
      <div>
        <h3 class="text-lg leading-6 font-medium text-gray-900">
          <%= t('tasks.show.basic_info') %>
        </h3>
        <p class="mt-1 max-w-2xl text-sm text-gray-500">
          <%= t('tasks.show.task_details') %>
        </p>
      </div>
    </div>
    <div class="border-t border-gray-200">
      <dl>
        <div class="bg-gray-50 px-4 py-4 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
          <dt class="text-sm font-medium text-gray-500 flex items-center">
            <svg class="w-4 h-4 mr-2 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"></path>
            </svg>
            <%= t('tasks.show.task_type') %>
          </dt>
          <dd class="mt-1 text-sm text-gray-900 sm:mt-0 sm:col-span-2">
            <span class="px-2.5 py-1 rounded-full text-xs font-medium
              <%= case @task.task_type
                  when 'map_build_auto' then 'bg-purple-100 text-purple-800'
                  when 'navigation_to_point' then 'bg-green-100 text-green-800'
                  when 'fetch_book_to_transfer' then 'bg-blue-100 text-blue-800'
                  when 'return_book_from_transfer' then 'bg-yellow-100 text-yellow-800'
                  when 'inventory_scan_and_relocate' then 'bg-orange-100 text-orange-800'
                  when 'inventory_full_inspection' then 'bg-red-100 text-red-800'
                  when 'load_map' then 'bg-indigo-100 text-indigo-800'
                  else 'bg-gray-100 text-gray-800'
                  end %>">
              <%= t("activerecord.enums.task.task_type.#{@task.task_type}") %>
            </span>
          </dd>
        </div>
        <div class="bg-white px-4 py-4 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
          <dt class="text-sm font-medium text-gray-500 flex items-center">
            <svg class="w-4 h-4 mr-2 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            <%= t('tasks.show.status') %>
          </dt>
          <dd class="mt-1 text-sm text-gray-900 sm:mt-0 sm:col-span-2">
            <span class="px-2.5 py-1 rounded-full text-xs font-medium
              <%= case @task.status
                  when 'pending' then 'bg-gray-100 text-gray-800'
                  when 'processing' then 'bg-blue-100 text-blue-800'
                  when 'completed' then 'bg-green-100 text-green-800'
                  when 'failed' then 'bg-red-100 text-red-800'
                  when 'cancelled' then 'bg-yellow-100 text-yellow-800'
                  when 'cancelling' then 'bg-orange-100 text-orange-800'
                  end %>">
              <%= t("activerecord.enums.task.status.#{@task.status}") %>
            </span>
          </dd>
        </div>
        <div class="bg-gray-50 px-4 py-4 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
          <dt class="text-sm font-medium text-gray-500 flex items-center">
            <svg class="w-4 h-4 mr-2 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
            </svg>
            <%= t('tasks.show.creator') %>
          </dt>
          <dd class="mt-1 text-sm text-gray-900 sm:mt-0 sm:col-span-2 flex items-center">
            <%= @task.user.username %>
          </dd>
        </div>
        <div class="bg-white px-4 py-4 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
          <dt class="text-sm font-medium text-gray-500 flex items-center">
            <svg class="w-4 h-4 mr-2 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 21v-4m0 0V5a2 2 0 012-2h6.5l1 1H21l-3 6 3 6h-8.5l-1-1H5a2 2 0 00-2 2zm9-13.5V9"></path>
            </svg>
            <%= t('tasks.show.priority') %>
          </dt>
          <dd class="mt-1 text-sm text-gray-900 sm:mt-0 sm:col-span-2">
            <span class="px-2.5 py-1 rounded-md text-xs font-medium bg-gray-100 text-gray-800">
              <%= @task.priority %>
            </span>
          </dd>
        </div>
        <div class="bg-gray-50 px-4 py-4 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
          <dt class="text-sm font-medium text-gray-500 flex items-center">
            <svg class="w-4 h-4 mr-2 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
            </svg>
            <%= t('tasks.show.created_at') %>
          </dt>
          <dd class="mt-1 text-sm text-gray-900 sm:mt-0 sm:col-span-2">
            <%= @task.created_at.strftime('%Y-%m-%d %H:%M:%S') %>
          </dd>
        </div>
        <div class="bg-white px-4 py-4 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
          <dt class="text-sm font-medium text-gray-500 flex items-center">
            <svg class="w-4 h-4 mr-2 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            <%= t('tasks.show.started_at') %>
          </dt>
          <dd class="mt-1 text-sm text-gray-900 sm:mt-0 sm:col-span-2">
            <%= @task.started_at ? @task.started_at.strftime('%Y-%m-%d %H:%M:%S') : '-' %>
          </dd>
        </div>
        <div class="bg-gray-50 px-4 py-4 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
          <dt class="text-sm font-medium text-gray-500 flex items-center">
            <svg class="w-4 h-4 mr-2 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
            </svg>
            <%= t('tasks.show.completed_at') %>
          </dt>
          <dd class="mt-1 text-sm text-gray-900 sm:mt-0 sm:col-span-2 task-completed-at">
            <%= @task.completed_at ? @task.completed_at.strftime('%Y-%m-%d %H:%M:%S') : '-' %>
          </dd>
        </div>
      </dl>
    </div>
  </div>

  <!-- 修改进度详情显示区域 -->
  <% if @task.progress_details.present? %>
    <div class="bg-white shadow overflow-hidden sm:rounded-lg task-progress-details">
      <div class="px-4 py-5 sm:px-6 border-b border-gray-200 flex items-center justify-between">
        <div class="flex items-center">
        <div class="bg-blue-100 p-2 rounded-md mr-3">
          <svg class="w-5 h-5 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
          </svg>
        </div>
        <div>
          <h3 class="text-lg leading-6 font-medium text-gray-900">
            <%= t('tasks.show.progress_details') %>
          </h3>
            <p class="mt-1 max-w-2xl text-sm text-gray-500 task-status-message">
              <% if @task.status == 'processing' %>
                <%= t('tasks.show.task_in_progress') %>
              <% elsif @task.status == 'completed' %>
                <%= t('tasks.show.task_completed') %>
              <% elsif @task.status == 'failed' %>
                <%= t('tasks.show.task_failed') %>
              <% elsif @task.status == 'cancelled' %>
                <%= t('tasks.show.task_cancelled') %>
              <% elsif @task.status == 'cancelling' %>
                <%= t('tasks.show.task_cancelling') %>
              <% else %>
                <%= t('tasks.show.task_pending') %>
              <% end %>
            </p>
          </div>
        </div>

        <!-- 添加新的进度条 -->
        <% if @task.status == 'processing' %>
          <div class="w-1/3">
            <div class="w-full bg-gray-200 rounded-full h-2.5">
              <div class="bg-blue-600 h-2.5 rounded-full task-progress-bar" style="width: 0%"></div>
            </div>
            <div class="text-xs text-right mt-1 text-gray-500 task-progress-percentage">0%</div>
          </div>
        <% end %>
      </div>

      <div class="p-4">
        <% details = @task.progress_details.is_a?(String) ? JSON.parse(@task.progress_details) : @task.progress_details %>
        
        <!-- 进度更新列表 -->
        <div class="task-updates-list">
          <% if details['updates'].present? %>
            <% details['updates'].sort_by { |u| -u['timestamp'].to_i }.each do |update| %>
              <div class="mb-2 p-3 bg-gray-50 rounded-md">
                <div class="flex justify-between items-center mb-1">
                  <span class="text-sm font-medium"><%= update['status_from_ros'] || t('tasks.show.status_update') %></span>
                  <span class="text-xs text-gray-500"><%= Time.at(update['timestamp'].to_i).strftime('%Y-%m-%d %H:%M:%S') %></span>
                </div>
                <% if update['message'].present? %>
                  <p class="text-sm text-gray-700"><%= update['message'] %></p>
                <% end %>
                <% if update['progress_percentage'].present? %>
                  <div class="mt-1 w-full bg-gray-200 rounded-full h-2.5">
                    <div class="bg-blue-600 h-2.5 rounded-full" style="width: <%= update['progress_percentage'] %>%"></div>
                  </div>
                <% end %>
              </div>
            <% end %>
          <% else %>
            <p class="text-sm text-gray-500"><%= t('tasks.show.no_updates_yet') %></p>
          <% end %>
        </div>
      </div>
    </div>
  <% end %>

  <!-- 任务关联部分 -->
  <% if @task.book || @task.source_slot || @task.target_slot || @task.target_point_x || @task.target_point_y || @task.target_point_z || @task.parent_task || @task.sub_tasks.exists? %>
    <div class="bg-white shadow overflow-hidden sm:rounded-lg">
      <div class="px-4 py-5 sm:px-6 border-b border-gray-200 flex items-center">
        <div class="bg-green-100 p-2 rounded-md mr-3">
          <svg class="w-5 h-5 text-green-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"></path>
          </svg>
        </div>
        <div>
          <h3 class="text-lg leading-6 font-medium text-gray-900">
            <%= t('tasks.show.related_info') %>
          </h3>
          <p class="mt-1 max-w-2xl text-sm text-gray-500">
            <%= t('tasks.show.related_entities') %>
          </p>
        </div>
      </div>

      <div class="border-t border-gray-200">
        <dl>
          <% if @task.book %>
            <div class="bg-gray-50 px-4 py-4 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
              <dt class="text-sm font-medium text-gray-500 flex items-center">
                <svg class="w-4 h-4 mr-2 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
                </svg>
                <%= t('tasks.show.related_book') %>
              </dt>
              <dd class="mt-1 text-sm text-gray-900 sm:mt-0 sm:col-span-2">
                <%= link_to @task.book.title, book_path(@task.book), class: "text-blue-600 hover:text-blue-900 hover:underline" %>
              </dd>
            </div>
          <% end %>
          
          <% if @task.source_slot %>
            <div class="bg-white px-4 py-4 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
              <dt class="text-sm font-medium text-gray-500 flex items-center">
                <svg class="w-4 h-4 mr-2 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"></path>
                </svg>
                <%= t('tasks.show.source_slot') %>
              </dt>
              <dd class="mt-1 text-sm text-gray-900 sm:mt-0 sm:col-span-2">
                <%= link_to @task.source_slot.bookshelf.name, bookshelf_path(@task.source_slot.bookshelf), class: "text-blue-600 hover:text-blue-900 hover:underline mr-1" %>
                <span class="px-2 py-1 rounded-md text-xs bg-gray-100 text-gray-800">
                  <%= t('tasks.show.level_row', level: @task.source_slot.level + 1, row: @task.source_slot.row + 1) %>
                </span>
              </dd>
            </div>
          <% end %>
          
          <% if @task.target_slot %>
            <div class="<%= @task.source_slot ? "bg-gray-50" : "bg-white" %> px-4 py-4 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
              <dt class="text-sm font-medium text-gray-500 flex items-center">
                <svg class="w-4 h-4 mr-2 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                </svg>
                <%= t('tasks.show.target_slot') %>
              </dt>
              <dd class="mt-1 text-sm text-gray-900 sm:mt-0 sm:col-span-2">
                <%= link_to @task.target_slot.bookshelf.name, bookshelf_path(@task.target_slot.bookshelf), class: "text-blue-600 hover:text-blue-900 hover:underline mr-1" %>
                <span class="px-2 py-1 rounded-md text-xs bg-gray-100 text-gray-800">
                  <%= t('tasks.show.level_row', level: @task.target_slot.level + 1, row: @task.target_slot.row + 1) %>
                </span>
              </dd>
            </div>
          <% end %>
          
          <% if @task.target_point_x || @task.target_point_y || @task.target_point_z %>
            <div class="<%= (@task.source_slot && !@task.target_slot) || (!@task.source_slot && @task.target_slot) ? "bg-gray-50" : "bg-white" %> px-4 py-4 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
              <dt class="text-sm font-medium text-gray-500 flex items-center">
                <svg class="w-4 h-4 mr-2 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 15l-2 5L9 9l11 4-5 2zm0 0l5 5M7.188 2.239l.777 2.897M5.136 7.965l-2.898-.777M13.95 4.05l-2.122 2.122m-5.657 5.656l-2.12 2.122"></path>
                </svg>
                <%= t('tasks.show.target_coordinates') %>
              </dt>
              <dd class="mt-1 text-sm text-gray-900 sm:mt-0 sm:col-span-2">
                <div class="flex space-x-2">
                  <span class="px-2 py-1 rounded-md text-xs bg-blue-100 text-blue-800">X: <%= @task.target_point_x || '-' %></span>
                  <span class="px-2 py-1 rounded-md text-xs bg-green-100 text-green-800">Y: <%= @task.target_point_y || '-' %></span>
                  <span class="px-2 py-1 rounded-md text-xs bg-red-100 text-red-800">Z: <%= @task.target_point_z || '-' %></span>
                </div>
              </dd>
            </div>
          <% end %>
          
          <% if @task.parent_task %>
            <div class="<%= (@task.target_point_x || @task.target_point_y || @task.target_point_z) ? "bg-gray-50" : "bg-white" %> px-4 py-4 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
              <dt class="text-sm font-medium text-gray-500 flex items-center">
                <svg class="w-4 h-4 mr-2 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"></path>
                </svg>
                <%= t('tasks.show.parent_task') %>
              </dt>
              <dd class="mt-1 text-sm text-gray-900 sm:mt-0 sm:col-span-2">
                <%= link_to "##{@task.parent_task_id}", task_path(@task.parent_task), class: "inline-flex items-center text-blue-600 hover:text-blue-900 hover:underline" do %>
                  <span class="mr-1.5">任务 #<%= @task.parent_task_id %></span>
                  <span class="px-2 py-0.5 rounded-full text-xs font-medium
                    <%= case @task.parent_task.status
                        when 'pending' then 'bg-gray-100 text-gray-800'
                        when 'processing' then 'bg-blue-100 text-blue-800'
                        when 'completed' then 'bg-green-100 text-green-800'
                        when 'failed' then 'bg-red-100 text-red-800'
                        when 'cancelled' then 'bg-yellow-100 text-yellow-800'
                        when 'cancelling' then 'bg-orange-100 text-orange-800'
                        end %>">
                    <%= t("activerecord.enums.task.status.#{@task.parent_task.status}") %>
                  </span>
                <% end %>
              </dd>
            </div>
          <% end %>
          
          <% if @task.sub_tasks.exists? %>
            <div class="<%= (@task.parent_task || @task.target_point_x || @task.target_point_y || @task.target_point_z) ? "bg-white" : "bg-gray-50" %> px-4 py-4 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
              <dt class="text-sm font-medium text-gray-500 flex items-center">
                <svg class="w-4 h-4 mr-2 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"></path>
                </svg>
                <%= t('tasks.show.sub_tasks') %>
              </dt>
              <dd class="mt-1 text-sm sm:mt-0 sm:col-span-2">
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-2">
                  <% @task.sub_tasks.each do |sub_task| %>
                    <%= link_to task_path(sub_task), class: "flex items-center justify-between bg-gray-50 rounded-md px-3 py-2 hover:bg-gray-100 transition duration-150" do %>
                      <div class="flex items-center">
                        <span class="font-medium text-gray-900">#<%= sub_task.id %></span>
                        <span class="ml-2 text-xs text-gray-500">
                          <%= t("activerecord.enums.task.task_type.#{sub_task.task_type}") %>
                        </span>
                      </div>
                      <span class="px-2 py-0.5 rounded-full text-xs font-medium
                        <%= case sub_task.status
                            when 'pending' then 'bg-gray-100 text-gray-800'
                            when 'processing' then 'bg-blue-100 text-blue-800'
                            when 'completed' then 'bg-green-100 text-green-800'
                            when 'failed' then 'bg-red-100 text-red-800'
                            when 'cancelled' then 'bg-yellow-100 text-yellow-800'
                            when 'cancelling' then 'bg-orange-100 text-orange-800'
                            end %>">
                        <%= t("activerecord.enums.task.status.#{sub_task.status}") %>
                      </span>
                    <% end %>
                  <% end %>
                </div>
              </dd>
            </div>
          <% end %>
        </dl>
      </div>
    </div>
  <% end %>

  <!-- 任务结果 -->
  <% if @task.result_data.present? %>
    <div class="bg-white shadow overflow-hidden sm:rounded-lg">
      <div class="px-4 py-5 sm:px-6 border-b border-gray-200 flex items-center">
        <div class="bg-green-100 p-2 rounded-md mr-3">
          <svg class="w-5 h-5 text-green-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"></path>
          </svg>
        </div>
        <div>
          <h3 class="text-lg leading-6 font-medium text-gray-900">
            <%= t('tasks.show.result_data') %>
          </h3>
        </div>
      </div>
      <div class="px-4 py-5 sm:px-6">
        <div class="bg-gray-50 p-4 rounded-lg overflow-auto max-h-96 border border-gray-200">
          <% 
            result_data = @task.result_data.is_a?(String) ? JSON.parse(@task.result_data) : @task.result_data 
            pretty_result = JSON.pretty_generate(result_data)
          %>
          <pre class="text-xs font-mono overflow-x-auto whitespace-pre-wrap break-words text-gray-800"><%= pretty_result %></pre>
        </div>
      </div>
    </div>
  <% end %>
  
  <!-- 系统日志 -->
  <div class="bg-white shadow overflow-hidden sm:rounded-lg">
    <div class="px-4 py-5 sm:px-6 border-b border-gray-200 flex items-center justify-between">
      <div class="flex items-center">
        <div class="bg-purple-100 p-2 rounded-md mr-3">
          <svg class="w-5 h-5 text-purple-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
          </svg>
        </div>
        <div>
          <h3 class="text-lg leading-6 font-medium text-gray-900">
            <%= t('tasks.show.system_logs') %>
          </h3>
          <p class="mt-1 max-w-2xl text-sm text-gray-500">
            <%= t('tasks.show.log_count', count: @logs.count) %>
          </p>
        </div>
      </div>
      
      <% if @logs.exists? %>
        <button id="toggle-logs" class="inline-flex items-center px-3 py-2 border border-purple-300 shadow-sm text-sm font-medium rounded-md text-purple-700 bg-purple-50 hover:bg-purple-100 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500 transition-all duration-200">
          <svg id="expand-icon" class="h-5 w-5 mr-1.5 text-purple-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
          </svg>
          <svg id="collapse-icon" class="h-5 w-5 mr-1.5 text-purple-500 hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"></path>
          </svg>
          <span id="toggle-text">展开所有</span>
        </button>
      <% end %>
    </div>

    <div class="px-4 py-5 sm:px-6">
      <% if @logs.exists? %>
        <div class="space-y-4 log-container">
          <% @logs.each do |log| %>
            <div class="log-item p-4 rounded-lg border <%= 
              case log.severity
              when 'info' then 'bg-blue-50 border-blue-200'
              when 'warning' then 'bg-yellow-50 border-yellow-200'
              when 'error_level' then 'bg-red-50 border-red-200'
              when 'critical' then 'bg-purple-50 border-purple-200'
              else 'bg-gray-50 border-gray-200'
              end %>">
              <div class="flex flex-wrap justify-between items-start gap-2">
                <div class="flex flex-wrap items-center gap-2">
                  <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium <%= 
                    case log.severity
                    when 'info' then 'bg-blue-100 text-blue-800'
                    when 'warning' then 'bg-yellow-100 text-yellow-800'
                    when 'error_level' then 'bg-red-100 text-red-800'
                    when 'critical' then 'bg-purple-100 text-purple-800'
                    else 'bg-gray-100 text-gray-800'
                    end %>">
                    <% if log.severity == 'info' %>
                      <svg class="h-3 w-3 mr-1 inline-block" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="10"></circle>
                        <line x1="12" y1="16" x2="12" y2="12"></line>
                        <line x1="12" y1="8" x2="12.01" y2="8"></line>
                      </svg>
                    <% elsif log.severity == 'warning' %>
                      <svg class="h-3 w-3 mr-1 inline-block" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
                        <line x1="12" y1="9" x2="12" y2="13"></line>
                        <line x1="12" y1="17" x2="12.01" y2="17"></line>
                      </svg>
                    <% elsif log.severity == 'error_level' %>
                      <svg class="h-3 w-3 mr-1 inline-block" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="10"></circle>
                        <line x1="15" y1="9" x2="9" y2="15"></line>
                        <line x1="9" y1="9" x2="15" y2="15"></line>
                      </svg>
                    <% elsif log.severity == 'critical' %>
                      <svg class="h-3 w-3 mr-1 inline-block" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"></path>
                      </svg>
                    <% end %>
                    <%= t("activerecord.attributes.system_log.severities.#{log.severity}") %>
                  </span>
                  <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                    <% if log.log_type == 'system' %>
                      <svg class="h-3 w-3 mr-1 inline-block" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <rect x="2" y="3" width="20" height="14" rx="2" ry="2"></rect>
                        <line x1="8" y1="21" x2="16" y2="21"></line>
                        <line x1="12" y1="17" x2="12" y2="21"></line>
                      </svg>
                    <% elsif log.log_type == 'robot' %>
                      <svg class="h-3 w-3 mr-1 inline-block" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <rect x="3" y="11" width="18" height="10" rx="2" ry="2"></rect>
                        <circle cx="12" cy="5" r="2"></circle>
                        <path d="M12 7v4"></path>
                        <line x1="8" y1="16" x2="8" y2="16"></line>
                        <line x1="16" y1="16" x2="16" y2="16"></line>
                      </svg>
                    <% elsif log.log_type == 'user' %>
                      <svg class="h-3 w-3 mr-1 inline-block" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                        <circle cx="12" cy="7" r="4"></circle>
                      </svg>
                    <% elsif log.log_type == 'task' %>
                      <svg class="h-3 w-3 mr-1 inline-block" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path>
                        <rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect>
                        <path d="M9 14l2 2 4-4"></path>
                      </svg>
                    <% elsif log.log_type == 'error' %>
                      <svg class="h-3 w-3 mr-1 inline-block" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polygon points="7.86 2 16.14 2 22 7.86 22 16.14 16.14 22 7.86 22 2 16.14 2 7.86 7.86 2"></polygon>
                        <line x1="12" y1="8" x2="12" y2="12"></line>
                        <line x1="12" y1="16" x2="12.01" y2="16"></line>
                      </svg>
                    <% end %>
                    <%= t("activerecord.attributes.system_log.log_types.#{log.log_type}") %>
                  </span>
                </div>
                <span class="text-xs text-gray-500 font-mono">
                  <svg class="h-3 w-3 inline-block mr-1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="10"></circle>
                    <polyline points="12 6 12 12 16 14"></polyline>
                  </svg>
                  <%= log.created_at.strftime('%Y-%m-%d %H:%M:%S') %>
                </span>
              </div>
              
              <div class="mt-3">
                <div class="log-message">
                  <p class="text-sm text-gray-800 break-words line-clamp-2"><%= log.message %></p>
                  <% if log.message.length > 120 %>
                    <button class="expand-log text-xs text-blue-600 hover:text-blue-800 mt-1 focus:outline-none">
                      <span class="show-more-text">显示更多</span>
                      <span class="show-less-text hidden">显示更少</span>
                    </button>
                  <% end %>
                </div>
                <p class="text-xs text-gray-500 mt-2 flex items-center">
                  <svg class="h-3 w-3 inline-block mr-1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M20.24 12.24a6 6 0 0 0-8.49-8.49L5 10.5V19h8.5l6.74-6.76z"></path>
                    <line x1="16" y1="8" x2="2" y2="22"></line>
                    <line x1="17.5" y1="15" x2="9" y2="15"></line>
                  </svg>
                  <span class="font-medium"><%= t('tasks.show.log_source') %>:</span> 
                  <span class="ml-1 font-mono"><%= log.source %></span>
                </p>
              </div>
            </div>
          <% end %>
        </div>
      <% else %>
        <div class="text-center py-12">
          <svg class="mx-auto h-12 w-12 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"></path>
          </svg>
          <h3 class="mt-2 text-sm font-medium text-gray-900"><%= t('tasks.show.no_logs') %></h3>
          <p class="mt-1 text-sm text-gray-500"><%= t('tasks.show.no_logs_info') %></p>
        </div>
      <% end %>
    </div>
  </div>
</div>

<script>
  // 使用最基本的方式确保代码在页面加载后执行
  (function() {
    // 立即执行以避免变量污染全局作用域
    function setupLogControls() {
      console.log("设置日志控制...");
      
      // 为每个"显示更多"按钮添加点击事件
      var expandButtons = document.querySelectorAll('.expand-log');
      for (var i = 0; i < expandButtons.length; i++) {
        expandButtons[i].onclick = function() {
          var logMessage = this.closest('.log-message');
          var paragraph = logMessage.querySelector('p');
          var showMoreText = this.querySelector('.show-more-text');
          var showLessText = this.querySelector('.show-less-text');
          
          console.log("切换日志显示状态");
          
          if (paragraph.classList.contains('line-clamp-2')) {
            // 展开日志
            paragraph.style.display = 'block';
            paragraph.style.overflow = 'visible';
            paragraph.style.textOverflow = 'clip';
            paragraph.style.webkitLineClamp = 'none';
            paragraph.style.webkitBoxOrient = 'vertical';
            paragraph.classList.remove('line-clamp-2');
            
            showMoreText.style.display = 'none';
            showLessText.style.display = 'inline';
          } else {
            // 收起日志
            paragraph.style.display = '-webkit-box';
            paragraph.style.overflow = 'hidden';
            paragraph.style.textOverflow = 'ellipsis';
            paragraph.style.webkitLineClamp = '2';
            paragraph.style.webkitBoxOrient = 'vertical';
            paragraph.classList.add('line-clamp-2');
            
            showMoreText.style.display = 'inline';
            showLessText.style.display = 'none';
          }
          
          return false; // 阻止事件传播
        };
      }
      
      // 全部展开/收起功能
      var toggleButton = document.getElementById('toggle-logs');
      if (toggleButton) {
        toggleButton.onclick = function() {
          var expandIcon = document.getElementById('expand-icon');
          var collapseIcon = document.getElementById('collapse-icon');
          var toggleText = document.getElementById('toggle-text');
          var allParagraphs = document.querySelectorAll('.log-message p');
          var allShowMoreTexts = document.querySelectorAll('.show-more-text');
          var allShowLessTexts = document.querySelectorAll('.show-less-text');
          
          console.log("切换所有日志显示状态");
          
          if (!expandIcon.classList.contains('hidden')) {
            // 展开所有
            expandIcon.classList.add('hidden');
            collapseIcon.classList.remove('hidden');
            toggleText.textContent = '收起所有';
            
            for (var i = 0; i < allParagraphs.length; i++) {
              allParagraphs[i].style.display = 'block';
              allParagraphs[i].style.overflow = 'visible';
              allParagraphs[i].style.textOverflow = 'clip';
              allParagraphs[i].style.webkitLineClamp = 'none';
              allParagraphs[i].classList.remove('line-clamp-2');
            }
            
            for (var i = 0; i < allShowMoreTexts.length; i++) {
              allShowMoreTexts[i].style.display = 'none';
            }
            
            for (var i = 0; i < allShowLessTexts.length; i++) {
              allShowLessTexts[i].style.display = 'inline';
            }
          } else {
            // 收起所有
            expandIcon.classList.remove('hidden');
            collapseIcon.classList.add('hidden');
            toggleText.textContent = '展开所有';
            
            for (var i = 0; i < allParagraphs.length; i++) {
              allParagraphs[i].style.display = '-webkit-box';
              allParagraphs[i].style.overflow = 'hidden';
              allParagraphs[i].style.textOverflow = 'ellipsis';
              allParagraphs[i].style.webkitLineClamp = '2';
              allParagraphs[i].classList.add('line-clamp-2');
            }
            
            for (var i = 0; i < allShowMoreTexts.length; i++) {
              allShowMoreTexts[i].style.display = 'inline';
            }
            
            for (var i = 0; i < allShowLessTexts.length; i++) {
              allShowLessTexts[i].style.display = 'none';
            }
          }
          
          return false; // 阻止事件传播
        };
      }
      
      console.log("日志控制设置完成");
    }
    
    // 确保在DOM加载完成后运行
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', setupLogControls);
    } else {
      setupLogControls();
    }
    
    // 兼容Turbolinks/Turbo
    if (typeof Turbolinks !== 'undefined' || typeof Turbo !== 'undefined') {
      document.addEventListener('turbo:load', setupLogControls);
      document.addEventListener('turbolinks:load', setupLogControls);
    }
    
    // 额外安全措施：在页面完全加载后尝试再次运行
    window.addEventListener('load', setupLogControls);
    
    // 立即尝试运行一次
    setupLogControls();
  })();
</script>

<!-- 添加状态翻译元素 (隐藏) 供JavaScript使用 -->
<div class="hidden">
  <span data-status-translation="pending"><%= t('activerecord.enums.task.status.pending') %></span>
  <span data-status-translation="processing"><%= t('activerecord.enums.task.status.processing') %></span>
  <span data-status-translation="completed"><%= t('activerecord.enums.task.status.completed') %></span>
  <span data-status-translation="failed"><%= t('activerecord.enums.task.status.failed') %></span>
  <span data-status-translation="cancelled"><%= t('activerecord.enums.task.status.cancelled') %></span>
  <span data-status-translation="cancelling"><%= t('activerecord.enums.task.status.cancelling') %></span>
</div>
