<div class="mx-auto md:w-2/3 w-full">
  <div class="flex justify-between items-center mb-6">
    <h1 class="font-bold text-2xl"><%= t('tasks.edit.title') %></h1>
    <div class="flex space-x-2">
      <%= link_to t('tasks.edit.back_to_details'), @task, class: "rounded-lg py-2 px-5 bg-gray-100 inline-block font-medium" %>
      <%= link_to t('tasks.edit.back_to_list'), tasks_path, class: "rounded-lg py-2 px-5 bg-gray-100 inline-block font-medium" %>
    </div>
  </div>

  <div class="bg-white rounded-lg shadow p-6">
    <%= form_with(model: @task, class: "contents") do |form| %>
      <% if @task.errors.any? %>
        <div class="bg-red-50 p-4 rounded-lg mb-6">
          <div class="font-medium text-red-800">
            <%= pluralize(@task.errors.count, t('errors.messages.error')) %> <%= t('tasks.form.errors_count', count: @task.errors.count) %>
          </div>
          <ul class="list-disc pl-5 mt-2">
            <% @task.errors.each do |error| %>
              <li class="text-red-700"><%= error.full_message %></li>
            <% end %>
          </ul>
        </div>
      <% end %>

      <div id="common-fields" class="mb-6">
        <div class="mb-4 bg-gray-50 p-4 rounded-lg">
          <div class="flex items-center mb-2">
            <svg class="h-5 w-5 text-gray-500 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4h13M3 8h9m-9 4h6m4 0l4-4m0 0l4 4m-4-4v12"></path>
            </svg>
            <%= form.label :priority, t('tasks.new.priority'), class: "text-sm font-medium text-gray-700" %>
          </div>
          
          <div class="mt-2">
            <div class="flex items-center justify-between mb-1 text-xs text-gray-500">
              <span><%= t('tasks.new.priority_levels.low') %></span>
              <span><%= t('tasks.new.priority_levels.medium') %></span>
              <span><%= t('tasks.new.priority_levels.high') %></span>
            </div>
            
            <div class="flex items-center space-x-3">
              <input type="range" id="priority_slider" min="0" max="10" step="1" value="<%= @task.priority || 0 %>" 
                    class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-blue-600"
                    oninput="updatePriorityValue(this.value)">
              <%= form.number_field :priority, min: 0, max: 10, class: "w-16 text-center px-2 py-1 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500", 
                    id: "priority_number", oninput: "document.getElementById('priority_slider').value = this.value" %>
            </div>
            
            <div class="mt-2">
              <span id="priority_label" class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                <%= t('tasks.new.priority_levels.low') %>
              </span>
              <p class="mt-1 text-xs text-gray-500">
                <%= t('tasks.new.priority_value_hint') %>
              </p>
            </div>
          </div>
        </div>
      </div>

      <!-- 导航任务表单字段 -->
      <div id="navigation-fields" class="task-fields mb-6 <%= @task.task_type == 'navigation_to_point' ? '' : 'hidden' %>">
        <div class="bg-green-50 p-4 rounded-lg">
          <h3 class="font-medium text-lg mb-3 flex items-center border-b border-green-200 pb-2">
            <svg class="h-5 w-5 text-green-500 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd" />
            </svg>
            <%= t('tasks.navigation_params.title') %>
          </h3>
          
          <div class="mt-4 space-y-4">
            <!-- X坐标 -->
            <div class="relative">
              <label class="block text-sm font-medium text-gray-700 mb-1 flex items-center">
                <svg class="h-4 w-4 mr-1.5 text-green-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5v-4m0 4h-4m4 0l-5-5" />
                </svg>
                <%= t('tasks.navigation_params.target_point_x') %>
              </label>
              <div class="flex items-center">
                <div class="relative flex-grow">
                  <%= form.number_field :target_point_x, step: "0.1", class: "block w-full pl-7 pr-12 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500", placeholder: "0.0" %>
                  <div class="absolute inset-y-0 left-0 pl-2 flex items-center pointer-events-none">
                    <span class="text-gray-500 sm:text-sm">X:</span>
                  </div>
                  <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none">
                    <span class="text-gray-500 sm:text-sm">m</span>
                  </div>
                </div>
                <div class="ml-2 flex-shrink-0">
                  <button type="button" class="px-2 py-1 bg-gray-200 rounded-l-md hover:bg-gray-300" 
                          onclick="decrementValue('task_target_point_x', 0.1)">−</button>
                  <button type="button" class="px-2 py-1 bg-gray-200 rounded-r-md hover:bg-gray-300" 
                          onclick="incrementValue('task_target_point_x', 0.1)">+</button>
                </div>
              </div>
              <p class="mt-1 text-xs text-gray-500">X轴坐标 (左右方向)</p>
            </div>
            
            <!-- Y坐标 -->
            <div class="relative">
              <label class="block text-sm font-medium text-gray-700 mb-1 flex items-center">
                <svg class="h-4 w-4 mr-1.5 text-green-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5v-4m0 4h-4m4 0l-5-5" />
                </svg>
                <%= t('tasks.navigation_params.target_point_y') %>
              </label>
              <div class="flex items-center">
                <div class="relative flex-grow">
                  <%= form.number_field :target_point_y, step: "0.1", class: "block w-full pl-7 pr-12 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500", placeholder: "0.0" %>
                  <div class="absolute inset-y-0 left-0 pl-2 flex items-center pointer-events-none">
                    <span class="text-gray-500 sm:text-sm">Y:</span>
                  </div>
                  <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none">
                    <span class="text-gray-500 sm:text-sm">m</span>
                  </div>
                </div>
                <div class="ml-2 flex-shrink-0">
                  <button type="button" class="px-2 py-1 bg-gray-200 rounded-l-md hover:bg-gray-300" 
                          onclick="decrementValue('task_target_point_y', 0.1)">−</button>
                  <button type="button" class="px-2 py-1 bg-gray-200 rounded-r-md hover:bg-gray-300" 
                          onclick="incrementValue('task_target_point_y', 0.1)">+</button>
                </div>
              </div>
              <p class="mt-1 text-xs text-gray-500">Y轴坐标 (前后方向)</p>
            </div>
            
            <!-- Z坐标 -->
            <div class="relative">
              <label class="block text-sm font-medium text-gray-700 mb-1 flex items-center">
                <svg class="h-4 w-4 mr-1.5 text-green-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5v-4m0 4h-4m4 0l-5-5" />
                </svg>
                <%= t('tasks.navigation_params.target_point_z') %>
              </label>
              <div class="flex items-center">
                <div class="relative flex-grow">
                  <%= form.number_field :target_point_z, step: "0.1", class: "block w-full pl-7 pr-12 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500", placeholder: "0.0" %>
                  <div class="absolute inset-y-0 left-0 pl-2 flex items-center pointer-events-none">
                    <span class="text-gray-500 sm:text-sm">Z:</span>
                  </div>
                  <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none">
                    <span class="text-gray-500 sm:text-sm">m</span>
                  </div>
                </div>
                <div class="ml-2 flex-shrink-0">
                  <button type="button" class="px-2 py-1 bg-gray-200 rounded-l-md hover:bg-gray-300" 
                          onclick="decrementValue('task_target_point_z', 0.1)">−</button>
                  <button type="button" class="px-2 py-1 bg-gray-200 rounded-r-md hover:bg-gray-300" 
                          onclick="incrementValue('task_target_point_z', 0.1)">+</button>
                </div>
              </div>
              <p class="mt-1 text-xs text-gray-500">Z轴坐标 (上下方向)</p>
            </div>
            
            <div class="mt-3 pt-3 border-t border-green-200 text-xs text-gray-600">
              <p>点击 + / - 按钮可微调坐标值。输入坐标值时将自动调整到小数点后一位。</p>
            </div>
          </div>
        </div>
      </div>

      <!-- 书籍搬运任务表单字段 -->
      <div id="book-transfer-fields" class="task-fields mb-6 <%= ['fetch_book_to_transfer', 'return_book_from_transfer'].include?(@task.task_type) ? '' : 'hidden' %>">
        <h3 class="font-medium text-lg mb-2"><%= t('tasks.book_transfer_params.title') %></h3>
        
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-1"><%= t('tasks.book_transfer_params.select_book') %></label>
          <%= form.collection_select :book_id, @books, :id, :title, { include_blank: t('tasks.book_transfer_params.select_book_placeholder') }, 
            { class: "block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" } %>
        </div>
        
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-1"><%= t('tasks.book_transfer_params.source_slot') %></label>
          <%= form.collection_select :source_slot_id, @slots, :id, lambda { |s| "#{s.bookshelf.name} - #{t('slot.level')}#{s.level}#{t('slot.row')}#{s.row}" }, 
            { include_blank: t('tasks.book_transfer_params.select_source_slot') }, 
            { class: "block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" } %>
        </div>

        <div id="return-book-fields" class="mb-4 <%= @task.task_type == 'return_book_from_transfer' ? '' : 'hidden' %>">
          <label class="block text-sm font-medium text-gray-700 mb-1"><%= t('tasks.book_transfer_params.target_slot') %></label>
          <%= form.collection_select :target_slot_id, @slots, :id, lambda { |s| "#{s.bookshelf.name} - #{t('slot.level')}#{s.level}#{t('slot.row')}#{s.row}" }, 
            { include_blank: t('tasks.book_transfer_params.select_target_slot') }, 
            { class: "block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" } %>
        </div>
      </div>

      <!-- 建图任务表单字段 -->
      <div id="map-fields" class="task-fields mb-6 <%= @task.task_type == 'map_build_auto' ? '' : 'hidden' %>">
        <h3 class="font-medium text-lg mb-2"><%= t('tasks.map_params.title') %></h3>
        
        <% 
          parameters = {}
          if @task.progress_details.present?
            begin
              parameters = JSON.parse(@task.progress_details)
            rescue JSON::ParserError
              parameters = {}
            end
          end
        %>
        
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-1"><%= t('tasks.map_params.map_name') %></label>
          <input type="text" name="task[parameters][map_name]" value="<%= parameters['map_name'] %>" class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
        </div>
        
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-1"><%= t('tasks.map_params.time_limit') %></label>
          <input type="number" name="task[parameters][time_limit]" value="<%= parameters['time_limit'] || 10 %>" min="1" max="60" class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
        </div>
      </div>

      <!-- 加载地图任务表单字段 -->
      <div id="load-map-fields" class="task-fields mb-6 <%= @task.task_type == 'load_map' ? '' : 'hidden' %>">
        <h3 class="font-medium text-lg mb-2"><%= t('tasks.load_map_params.title') %></h3>
        
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-1"><%= t('tasks.load_map_params.map_id') %></label>
          <input type="text" name="task[parameters][map_id]" value="<%= parameters['map_id'] %>" class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
        </div>
      </div>

      <!-- 库存扫描任务表单字段 -->
      <div id="inventory-fields" class="task-fields mb-6 <%= ['inventory_scan_and_relocate', 'inventory_full_inspection'].include?(@task.task_type) ? '' : 'hidden' %>">
        <h3 class="font-medium text-lg mb-2"><%= t('tasks.inventory_params.title') %></h3>
        
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-1"><%= t('tasks.inventory_params.select_bookshelf') %></label>
          <select name="task[parameters][bookshelf_id]" class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
            <option value=""><%= t('tasks.inventory_params.all_bookshelves') %></option>
            <% Bookshelf.all.each do |bookshelf| %>
              <option value="<%= bookshelf.id %>" <%= parameters['bookshelf_id'].to_s == bookshelf.id.to_s ? 'selected' : '' %>><%= bookshelf.name %></option>
            <% end %>
          </select>
        </div>
        
        <div class="mb-4">
          <div class="flex items-center">
            <input id="auto-relocate" type="checkbox" name="task[parameters][auto_relocate]" value="true" <%= parameters['auto_relocate'] == true || parameters['auto_relocate'] == 'true' ? 'checked' : '' %> class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
            <label for="auto-relocate" class="ml-2 block text-sm text-gray-700"><%= t('tasks.inventory_params.auto_relocate') %></label>
          </div>
        </div>
      </div>

      <div class="mt-8">
        <%= form.submit t('tasks.edit.update_task'), class: "rounded-lg py-3 px-5 bg-blue-600 text-white font-medium cursor-pointer hover:bg-blue-700" %>
      </div>
    <% end %>
  </div>
</div>

<script>
  function updatePriorityValue(value) {
    document.getElementById('priority_number').value = value;
    updatePriorityLabel(value);
  }
  
  function updatePriorityLabel(value) {
    const label = document.getElementById('priority_label');
    const intValue = parseInt(value);
    
    if (intValue >= 0 && intValue <= 2) {
      label.textContent = '<%= t('tasks.new.priority_levels.low') %>';
      label.className = 'inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800';
    } else if (intValue >= 3 && intValue <= 7) {
      label.textContent = '<%= t('tasks.new.priority_levels.medium') %>';
      label.className = 'inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800';
    } else {
      label.textContent = '<%= t('tasks.new.priority_levels.high') %>';
      label.className = 'inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800';
    }
  }
  
  // 坐标值增减函数
  function incrementValue(inputId, step) {
    const input = document.getElementById(inputId);
    const currentValue = parseFloat(input.value) || 0;
    input.value = (Math.round((currentValue + step) * 10) / 10).toFixed(1);
  }
  
  function decrementValue(inputId, step) {
    const input = document.getElementById(inputId);
    const currentValue = parseFloat(input.value) || 0;
    input.value = (Math.round((currentValue - step) * 10) / 10).toFixed(1);
  }
  
  // 初始化时设置标签
  document.addEventListener('DOMContentLoaded', function() {
    updatePriorityLabel(document.getElementById('priority_number').value);
  });
</script>
