#!/bin/bash
set -e

# 如果是Rails web服务器
if [[ "$1" == "web" || -z "$1" ]]; then
  # 简单地检查Rails进程是否运行
  if pgrep -f "rails server" > /dev/null; then
    echo "Rails server running"
    exit 0
  else
    echo "Rails server not running"
    exit 1
  fi
fi

# 如果是Sidekiq worker
if [[ "$1" == "worker" ]]; then
  # 检查Sidekiq进程
  if pgrep -f "sidekiq" > /dev/null; then
    echo "Sidekiq process running"
    exit 0
  fi
  
  # 如果没有找到进程，检查日志是否有致命错误
  if grep -q "ERROR" /rails/log/sidekiq.log 2>/dev/null; then
    echo "Sidekiq errors found in log"
    exit 1
  fi
  
  echo "Sidekiq not running properly"
  exit 1
fi

# 默认情况
echo "Unknown service type: $1"
exit 1
