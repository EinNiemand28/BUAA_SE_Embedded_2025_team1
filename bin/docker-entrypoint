#!/bin/bash
set -e

rm -f /rails/tmp/pids/server.pid

# 如果是rails命令且数据库存在，则先运行迁移
if [ "${1}" == "bin/rails" ] && [ "${2}" == "server" ]; then
  echo "Preparing database if needed..."
  ./bin/rails db:prepare
  
  # 如果环境变量设置了RAILS_MIGRATE，则运行迁移
  if [ "${RAILS_MIGRATE}" == "true" ]; then
    echo "Running database migrations..."
    ./bin/rails db:migrate
  fi
fi

# 执行传入的命令
exec "${@}" 