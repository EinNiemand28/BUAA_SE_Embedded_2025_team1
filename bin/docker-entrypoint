#!/bin/bash
set -e

# 始终移除 pid 文件
rm -f /rails/tmp/pids/server.pid

if [ "${RAILS_ENV}" == "production" ] && [ "${1}" == "bin/rails" ] && [ "${2}" == "server" ]; then
  echo "Production environment detected, creating database if needed..."
  # 尝试创建数据库
  bundle exec rails db:create 2>/dev/null || true
  bundle exec rails db:migrate 2>/dev/null || true
  # 跳过完整准备过程
  echo "Database setup completed."
else
  # 开发环境正常执行
  if [ "${1}" == "bin/rails" ] && [ "${2}" == "server" ]; then
    echo "Preparing database if needed..."
    ./bin/rails db:prepare
  fi
fi

# 然后执行传入的命令
exec "$@" 